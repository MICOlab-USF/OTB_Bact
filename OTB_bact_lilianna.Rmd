---
title: "OTB_bact_lilianna"
author: "Lilianna"
date: "2025-11-06"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


import packages and functions
```{r packages, warning=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(purrr)
"%ni%" <- Negate("%in%")
library(googlesheets4)
library(patchwork)
library(broom)
library(flextable)
library(kableExtra)
library(growthrates)
library(readr)
library(ggspatial)
```


```{r}
data_headers<- c("Sample", "X.Parameter", "Y.Parameter", "Concentration", "Date", "X.Mean", "Y.Mean", "X.SD", "Y.SD")

directory = "OTB_Sampling_2025"

bact_counts_func <- function(data_headers, directory) { 
  # make empty dataframe 
  HWdf = data.frame(matrix(
  vector(), 0, length(data_headers), dimnames=list(c(), data_headers)),
                stringsAsFactors=F)
  
  # import bacterial count data
  for (i in list.files(directory, pattern = "\\.csv$")) {
  df <- read.csv(file.path(directory, i))
  date <- str_split_i(i, "_", 3)
  date2 <- str_extract(date, '.*(?=\\.csv$)')
  df$Date <- date2
  HWdf <- rbind(HWdf, df)
}

  HWdf$Date <- ymd(HWdf$Date)
  return(HWdf)
}

bactcounts<- bact_counts_func(data_headers, directory)
```


```{r}
bactcounts <- bactcounts %>% separate(Sample, into = c("station", "rep", "mix"), sep = "_") %>% 
  mutate(rep = case_when(rep %in% c(1,2,3) ~ rep, rep %ni% c(1,2,3) ~ mix)  ) %>%  select(!mix)
```
```{r}
bactcounts<-read.csv("C:/Users/lilia/OneDrive/Desktop/OTB_Bact/OTB_Sampling_2025/OTB_BACT_20250508.csv")
head(bactcounts)
```
## 05/08/2025 R3
```{r}
bact_R2 <- bactcounts %>%
  filter(Gate == "R3") %>%
  mutate(Station = str_extract(Sample, "St\\d+"))

bact_summary <- bact_R2 %>%
  group_by(Station) %>%
  summarise(
    Mean_Conc = mean(Concentration, na.rm = TRUE),
    SD_Conc   = sd(Concentration, na.rm = TRUE)
  )


bact_summary <- bact_summary %>%
  filter(!is.na(Station)) %>%
  mutate(Station = factor(Station, levels = paste0("St", 1:10)))


ggplot(bact_summary, aes(x = Station, y = Mean_Conc)) +
  geom_point(size = 3, color = "darkblue") +
  geom_errorbar(aes(ymin = Mean_Conc - SD_Conc,
                    ymax = Mean_Conc + SD_Conc),
                width = 0.2, color = "gray40") +
  theme_test() +
  labs(
    title = "Bacterial Concentration (Gate R3) by Station",
    x = "Station",
    y = "Mean Concentration (cells/μL)"
  )

```
## All dates
```{r}
data_dir <- "C:/Users/lilia/OneDrive/Desktop/OTB_Bact/OTB_Sampling_2025"
files <- list.files(data_dir, pattern = "OTB_BACT_.*\\.csv$", full.names = TRUE)
read_and_clean <- function(file) {
  df <- read_csv(file)
  

  date_str <- str_extract(basename(file), "\\d{8}")
  df$Date <- lubridate::ymd(date_str)
  
  df %>%
    filter(Gate == "R3") %>%
    mutate(Station = str_extract(Sample, "St\\d+")) %>%
    filter(!is.na(Station)) %>%
    group_by(Date, Station) %>%
    summarise(
      Mean_Conc = mean(Concentration, na.rm = TRUE),
      SD_Conc   = sd(Concentration, na.rm = TRUE),
      .groups = "drop"
    )
}

bact_all <- map_dfr(files, read_and_clean)
```
```{r}
bact_all <- bact_all %>%
  mutate(
    Station = factor(Station, levels = paste0("St", 1:10)),
    Date = as.factor(Date)
  )
ggplot(bact_all, aes(x = Station, y = Mean_Conc)) +
  geom_point(size = 2, color = "darkblue") +
  #geom_line(aes(group = 1), color = "skyblue") +
  geom_errorbar(aes(ymin = Mean_Conc - SD_Conc,
                    ymax = Mean_Conc + SD_Conc),
                width = 0.2, color = "gray40") +
  theme_test(base_size = 10) +
  labs(
    title = "Bacterial Concentration (Gate R3) Across Sampling Dates",
    x = "Station",
    y = "Mean Concentration (cells/μL)"
  ) +
  facet_wrap(~ Date, ncol = 4)  

```
ggsave("OTB_Bact.jpg", width = 7, height = 4)

color = station
y= conc
x = time 


plot stations on map 
ggspatial
rnaturalearth
rnaturalearthdata
sf
ggOceanMaps
scatterpie


bioconductor 
## Station by color
```{r}
ggplot(bact_all, aes(x = Date, y = Mean_Conc, color = Station)) +
  geom_point(size = 2) +
  geom_line(aes(group = Station), linewidth = 0.6, alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean_Conc - SD_Conc,
                    ymax = Mean_Conc + SD_Conc),
                width = 0.1, alpha = 0.6) +
  theme_test(base_size = 10) +
  labs(
    title = "Bacterial Concentration (Gate R3) Over Time by Station",
    x = "Sampling Date",
    y = "Mean Concentration (cells/μL)",
    color = "Station"
  ) +
   scale_color_viridis_d(option = "turbo") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
bact_all %>% drop_na(Mean_Conc, SD_Conc)

```
ggsave("OTB_conc_overtime_by_station.jpg", width = 11, height = 8)
## Base Map
```{r}
library(ggOceanMaps)
coords <- read_sheet("https://docs.google.com/spreadsheets/d/1uMg7J9nv4E8PAOlW-msOi2YNinEexmcY7h_dJc_-OuE/edit?usp=sharing")

bact_geo <- bact_all %>%
  left_join(coords, by = "Station")
station_levels <- paste0("St", 1:10)
coords <- coords %>%
  mutate(Station = factor(Station, levels = station_levels))
bact_geo <- bact_geo %>%
  mutate(Station = factor(Station, levels = station_levels))
```


```{r}
# OTB map limits
limits <- c(lon_min = -82.8, lon_max = -82.5, lat_min = 27.6, lat_max = 28.1)

basemap(limits = limits) +
  geom_point(data = coords,
             aes(x = Long, y = Lat, color = Station),
             size = 3) +
  scale_color_viridis_d(option = "turbo") +
  labs(title = "OTB Sampling Stations",
       x = "Longitude", y = "Latitude", color = "Station")


```
## Heat Map
```{r}
basemap(limits = limits) +
  geom_point(
    data = bact_geo,
    aes(x = Long, y = Lat, color = Mean_Conc),
    size = 4,
    alpha = 0.9
  ) +
  geom_text(
    data = bact_geo,
    aes(x = Long, y = Lat, label = Station),
    color = "black",      # text color
    size = 3,             # adjust size as needed
    vjust = -1            # moves text slightly above the point
  ) +
  scale_color_viridis_c(
    option = "magma",
    name = "Mean Concentration (cells/μL)"
  ) +
  labs(
    title = "Bacterial Concentration at OTB Stations",
    x = "Longitude",
    y = "Latitude"
  )


```
ggsave("OTB_conc_by_station_heatmap.jpg", width = 11, height = 8)

