---
title: "OTB_rainfall"
author: "Lilianna"
date: "2025-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Weekly Avg
```{r}
library(readxl)
library(dplyr)
library(lubridate)
library(ggplot2)

# read Excel file
df <- read_excel("/Users/lilia/Downloads/OTB_Rainfall_Data.xlsx")

# clean ResultValue and parse datetime
df <- df %>%
  mutate(
    # clean numeric value (Excel stored it as text)
    ResultValue = as.numeric(gsub("[^0-9\\.]", "", ResultValue)),
    
    # parse combined date-time string
    SampleDate_Date = mdy_hms(SampleDate_Date)
  )

# filter down to only rainfall + date within date window
df_sub <- df %>%
  filter(Characteristic == "Daily Cumulative Rainfall") %>%
  filter(SampleDate_Date >= ymd("2025-05-01"),
         SampleDate_Date <= ymd("2025-10-31"))

# incremental rainfall from cumulative
df_sub <- df_sub %>%
  arrange(SampleDate_Date) %>%
  mutate(
    Rain_increment = ResultValue - lag(ResultValue),
    Rain_increment = ifelse(Rain_increment < 0, NA, Rain_increment)
  )

# weekly averages
weekly_avg <- df_sub %>%
  mutate(Week = floor_date(SampleDate_Date, "week")) %>%
  group_by(Week) %>%
  summarise(Weekly_avg_rain = mean(Rain_increment, na.rm = TRUE))



```

```{r}
weekly_avg <- weekly_avg %>%
  mutate(Week = as.Date(Week))

ggplot(weekly_avg, aes(x = Week, y = Weekly_avg_rain)) +
  geom_line(size = 1, color = "#1f77b4") +
  geom_point(size = 2, color = "#318") +
  scale_x_date(date_breaks = "1 week", date_labels = "%m/%d") +
  labs(
    title = "Average Weekly OTB Rainfall May-November 2025",
    x = "Week",
    y = "Average Rainfall (inches)"
  ) +
  theme_test() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
ggsave("OTB_rainfall.jpg", width = 9, height = 8)

## Cumul. 05-11

```{r}
# daily rainfall totals
# filter to daily cumulative rainfall and date window
daily_cum <- df %>%
  filter(Characteristic == "Daily Cumulative Rainfall") %>%
  filter(SampleDate_Date >= ymd("2025-05-01"),
         SampleDate_Date <= ymd("2025-11-30")) %>%
  mutate(Date = as.Date(SampleDate_Date))

daily_cum <- daily_cum %>%
  group_by(Date) %>%
  summarise(Daily_Cumulative_Rain = max(ResultValue, na.rm = TRUE)) %>%
  ungroup()
daily_cum <- daily_cum %>%
  mutate(Daily_Cumulative_Rain_mm = Daily_Cumulative_Rain * 25.4)

ggplot(daily_cum, aes(x = Date, y = Daily_Cumulative_Rain_mm)) +
  geom_col(fill = "#1f77b4") +
  scale_x_date(date_breaks = "1 week", date_labels = "%m/%d") +
  labs(
    title = "Daily Cumulative OTB Rainfall (May–November 2025)",
    x = "Date",
    y = "Daily Cumulative Rainfall (mm)"
  ) +
  theme_test() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```
ggsave("OTB_rainfall_12/13.jpg", width = 9, height = 8)

## Cumul. 04-11
```{r}
# daily rainfall totals
# filter to daily cumulative rainfall and date window
daily_cum <- df %>%
  filter(Characteristic == "Daily Cumulative Rainfall") %>%
  filter(SampleDate_Date >= ymd("2025-04-01"),
         SampleDate_Date <= ymd("2025-11-30")) %>%
  mutate(Date = as.Date(SampleDate_Date))

daily_cum <- daily_cum %>%
  group_by(Date) %>%
  summarise(Daily_Cumulative_Rain = max(ResultValue, na.rm = TRUE)) %>%
  ungroup()
daily_cum <- daily_cum %>%
  mutate(Daily_Cumulative_Rain_mm = Daily_Cumulative_Rain * 25.4)

ggplot(daily_cum, aes(x = Date, y = Daily_Cumulative_Rain_mm)) +
  geom_col(fill = "#1f77b4") +
  scale_x_date(date_breaks = "1 week", date_labels = "%m/%d") +
  labs(
    title = "Daily Cumulative OTB Rainfall (April–November 2025)",
    x = "Date",
    y = "Daily Cumulative Rainfall (mm)"
  ) +
  theme_test() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
ggsave("OTB_rainfall_april.jpg", width = 9, height = 8)

## Cumul. 03-11

```{r}
# daily rainfall totals
# filter to daily cumulative rainfall and date window
daily_cum <- df %>%
  filter(Characteristic == "Daily Cumulative Rainfall") %>%
  filter(SampleDate_Date >= ymd("2025-03-01"),
         SampleDate_Date <= ymd("2025-11-30")) %>%
  mutate(Date = as.Date(SampleDate_Date))

daily_cum <- daily_cum %>%
  group_by(Date) %>%
  summarise(Daily_Cumulative_Rain = max(ResultValue, na.rm = TRUE)) %>%
  ungroup()
daily_cum <- daily_cum %>%
  mutate(Daily_Cumulative_Rain_mm = Daily_Cumulative_Rain * 25.4)

ggplot(daily_cum, aes(x = Date, y = Daily_Cumulative_Rain_mm)) +
  geom_col(fill = "#1f77b4") +
  scale_x_date(date_breaks = "1 week", date_labels = "%m/%d") +
  labs(
    title = "Daily Cumulative OTB Rainfall (March–November 2025)",
    x = "Date",
    y = "Daily Cumulative Rainfall (mm)"
  ) +
  theme_test() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
ggsave("OTB_rainfall_march.jpg", width = 9, height = 8)


```{r}
sample_dates <- tibble(
  SampleDate = as.Date(c(
    "2025-05-08",
    "2025-06-19",
    "2025-07-01",
    "2025-07-31",
    "2025-08-29",
    "2025-09-25",
    "2025-10-14"
  ))
)
daily_rain <- daily_cum %>%
  arrange(Date) %>%
  mutate(Daily_Rain_mm = Daily_Cumulative_Rain_mm -
                           lag(Daily_Cumulative_Rain_mm)) %>%
  mutate(Daily_Rain_mm = ifelse(Daily_Rain_mm < 0, NA, Daily_Rain_mm))
rain_summary <- sample_dates %>%
  rowwise() %>%
  mutate(
    Rain_24h_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(1)
      ],
      na.rm = TRUE
    ),

    Rain_48h_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(2)
      ],
      na.rm = TRUE
    ),

    Rain_7d_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(7)
      ],
      na.rm = TRUE
    )
  ) %>%
  ungroup()
df <- sample_dates %>%
  rowwise() %>%
  mutate(
    Rain_24h_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(1)
      ],
      na.rm = TRUE
    ),

    Rain_48h_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(2)
      ],
      na.rm = TRUE
    ),

    Rain_7d_before_mm = sum(
      daily_rain$Daily_Rain_mm[
        daily_rain$Date < SampleDate &
        daily_rain$Date >= SampleDate - days(7)
      ],
      na.rm = TRUE
    )
  ) %>%
  ungroup()

df
```

